# Creating an IAM role to enable pods to access the DynamoDB tables
Our containerized applications will need to access the DynamoDB table that's storing all of the info

environment/workshop-1/app/monolith-service

# To Create DynamoDB :
aws dynamodb create-table \
  --table-name MysfitsTable \
  --attribute-definitions AttributeName=MysfitId,AttributeType=S \
  --key-schema AttributeName=MysfitId,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST

  # Configure DynamoDB policy :
  cat << EOF > iam-dynamodb-policy.json
{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Effect": "Allow",
			"Action": [
				"dynamodb:*"
			],
			"Resource": [
				"arn:aws:dynamodb:${AWS_REGION}:${ACCOUNT_ID}:table/${TABLE_NAME}",
				"arn:aws:dynamodb:${AWS_REGION}:${ACCOUNT_ID}:table/${TABLE_NAME}/index/*"
			]
		}
	]
}

# Create the DynamoDB IAM policy 

#create the policy
aws iam create-policy \
				--policy-name MythicalMisfitDynamoDBTablePolicy \
				--policy-document file://iam-dynamodb-policy.json


# get the policy ARN
export PolicyARNDynamoDB=$(aws iam list-policies --query 'Policies[?PolicyName==`MythicalMisfitDynamoDBTablePolicy`].Arn' --output text)
echo $PolicyARNDynamoDB

Output : arn:aws:iam::716713632458:policy/MythicalMisfitDynamoDBTablePolicy

# Create IAM role for Pod Identity ;
# Create IAM role with trust policy for Pod Identity
cat > trust-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "pods.eks.amazonaws.com"
      },
      "Action": [
        "sts:AssumeRole",
        "sts:TagSession"
      ]
    }
  ]
}
EOF

aws iam create-role --role-name MythicalMisfitRole --assume-role-policy-document file://trust-policy.json
aws iam attach-role-policy --role-name MythicalMisfitRole --policy-arn $PolicyARNDynamoDB


# Create the service account
kubectl create serviceaccount mythical-misfit -n default

# Create Pod Identity association
aws eks create-pod-identity-association \
    --cluster-name mythicaleks-eksctl \
    --namespace default \
    --service-account mythical-misfit \
    --role-arn arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/MythicalMisfitRole